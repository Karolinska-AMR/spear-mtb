$(document).ready(function(){let e=["ethambutol","pyrazinamide","isoniazid","rifampicin","rifabutin","ethionamide","fluoroquinolones","ciprofloxacin","moxifloxacin","levofloxacin","ofloxacin","gatifloxacin","aminoglycosides","streptomycin","amikacin","kanamycin","gentamicin","linezolid","bedaquiline","capreomycin","delamanid","clofazimine","cycloserine","para-aminosalicylic_acid","amoxicilin-clavulanate","amoxicilin","azithromycin","clarithromycin","d-cycloserine","ertapenem","imipenem","mefloquine","meropenem","pretomanid","pas","prothionamide","sitafloxacin","cotrimoxazole","sutezolid","terizidone","thioacetazone",],t=["TB-Profiler","CRyPTIC_GARC1_v1-311","WHO_GARC1_v1"],a={},l=!0,o=!1,i=[],n=-1,r=document.querySelector("#lin-tbl"),s=document.querySelector("#prd-tbl"),c=document.querySelector("#omu-tbl"),f=document.querySelector("#uvmu-tbl"),u=document.querySelectorAll("#prd-card .selected_id"),p;function b(){let e=document.querySelectorAll("#lin-tbl .show-detail");for(let t of e)t.addEventListener("click",function(e){let t=$(this).attr("data-sample"),a=document.querySelectorAll("#lin-tbl .show-detail svg"),l;for(let o of a)(l=$(o).closest("a").attr("data-sample"))===t?($(o).removeClass("fa-circle-down").addClass("fa-circle-right"),$(o).closest("tr").addClass("selected-row")):($(o).removeClass("fa-circle-right").addClass("fa-circle-down"),$(o).closest("tr").removeClass("selected-row"));n!=t&&(n=t,h(t),m(t),g(t),$(u).text(n)),e.preventDefault()});let a=document.querySelectorAll(".form-check-input");for(let i of a)i.addEventListener("change",function(e){let t=$(this).attr("data-type");"drugs"==t?l=$(this).prop("checked"):"mutations"==t&&(o=$(this).prop("checked")),h(n)})}function h(e){if(-1==e)return;$(s).bootstrapTable("destroy"),$(s).bootstrapTable({columns:i});let n=djson[e].res_var,r=djson[e].del_genes,c=djson[e].unverified_regions,f=new Set,u=[];a={},$.each(r,function(e,t){a[e]=1}),$.each(c,function(e,t){f.add(t.drug),a[t.drug]=1}),t.forEach(function(e,t){if(!n[e])return;muts=n[e];let l={cat:e};$.each(muts,function(e,t){let i="U";a[e]=1;let n=[];t.forEach(e=>{"R"==e.phenotype&&(i=e.phenotype);let t="R"==e.phenotype?"text-danger":"text-warning",a="";e.freq&&(a=`<span class="badge rounded-pill opacity-75 ${e.freq>.8?"bg-success text-white":"bg-warning text-dark"}">${e.freq}</span>`),n.push(`<p class='${t} fw-bold m-0 p-0'>${e.mutation} ${a}</p>`)}),o?l[e]=n.join(""):l[e]=i}),u.push(l)});document.querySelectorAll("#prd-tbl th").forEach(e=>{"cat"!=(d=e.getAttribute("data-field"))&&1!=a[d]&&l?$(s).bootstrapTable("hideColumn",d):$(s).bootstrapTable("showColumn",d)}),$.each(u,function(e,t){$(s).bootstrapTable("insertRow",{index:0,row:t})}),$.each(r,function(e,t){let a=[];t.forEach(e=>{"R"==e.phenotype&&(phenotype="R"),a.push(e.mutation)});let l;l=o?a.join(""):phenotype,$(s).bootstrapTable("updateCell",{index:0,field:e,value:`<p class="text-secondary" title="Complete deletion of the gene overrides the results of catalogues"><i class="fa-solid fa-scissors fa-xl blink" ></i></p><p class='text-danger fw-bold m-0 p-0'>${l}</p>`,reinit:!1}),$(s).bootstrapTable("mergeCells",{index:0,field:e,rowspan:3})}),f.forEach(function(e){$(`#prd-tbl th[data-field="${e}"]`).find(".th-inner").prepend("<span class='text-warning blink2' title='Unverified mutations due to low read coverage.'><i class=\"fa-solid fa-triangle-exclamation fa-xl\"></i> </span>")}),document.querySelectorAll("#prd-tbl td").forEach(e=>{"R"==e.innerText?$(e).addClass("table-danger text-danger fw-bold"):"U"==e.innerText&&$(e).addClass("table-warning text-warning fw-bold")})}function m(e){$(c).bootstrapTable("destroy"),$(c).bootstrapTable({columns:i});let l=djson[e].other_var,o=[];a={},t.forEach(function(e,t){if(!l[e])return;muts=l[e];let i={cat:e};$.each(muts,function(e,t){a[e]=1,mutations=[],t.forEach(e=>{let t="S"==e.phenotype?"text-success":"text-secondary",a="";e.freq&&(a=`<span class="d-inline badge rounded-pill opacity-75 p-1 ${e.freq>.8?"bg-success text-white":"bg-warning text-dark"}">${e.freq}</span>`),mutations.push(`<div class='${t} fw-bold m-0 p-0'><span class='d-inline'>${e.mutation}</span>${a}</div>`)}),i[e]=mutations.join("")}),o.push(i)}),Object.keys(a).length>0&&(document.querySelectorAll("#omu-tbl th").forEach(e=>{"cat"!=(d=e.getAttribute("data-field"))&&1!=a[d]&&$(c).bootstrapTable("hideColumn",d)}),$.each(o,function(e,t){$(c).bootstrapTable("insertRow",{index:0,row:t})}))}function g(e){$(f).bootstrapTable("destroy"),$(f).bootstrapTable({columns:[{field:"drug",title:"Drug",sortable:"true"},{field:"locus",title:"Locus name",sortable:"true"},{field:"gene",title:"Gene name",sortable:"true"},{field:"mutation",title:"Unverified Mutation",sortable:"true"},]}),$.each(djson[e].unverified_regions,function(e,t){t.mutation=`<p class='text-danger fw-bold m-0 p-0'>${t.mutation}</p>`,$(f).bootstrapTable("insertRow",{index:0,row:t})})}function y(){$(s).bootstrapTable("removeAll"),$(c).bootstrapTable("removeAll"),$(f).bootstrapTable("removeAll"),n=-1,a={}}p=[],$.each({action:"",id:"Seq. ID",lin:"Lineage",family:"Family",spoligotype:"Spoligotype",rd:"RD"},function(e,t){p.push({field:e,title:t,sortable:"action"!=e})}),$(r).bootstrapTable("destroy"),$(r).bootstrapTable({columns:p,onResetView:function(e){r.querySelectorAll("tbody tr").forEach(e=>{if($(e.children[1]).text()==n){$(e).addClass("selected-row"),e.children[0].innerHTML=`<a class="show-detail" type="button" href="#" data-sample = "${n}">
        <i class="fa fa-lg fa-circle-right"></i></a>`;return}}),b()}}),$(document.querySelector(".search")).addClass("input-group-sm m-0 pb-1"),$.each(djson,function(e,t){let a=Object.assign({},{id:t.seqid},t.lineage),l="";0==t.valid&&(l=a.family=`<a class="text-warning"><i class="fa fa-lg fa-exclamation-triangle"></i></a> ${a.family}`),a.action=`<a class="show-detail" type="button" href="#" data-sample = "${a.id}">
                  <i class="fa fa-lg fa-circle-down"></i></a>`,$(r).bootstrapTable("insertRow",{index:0,row:a})}),i.push({field:"cat",title:"Catalogue"}),$.each(e,function(e,t){i.push({field:t,title:t.charAt(0).toUpperCase()+t.slice(1)})}),b()});