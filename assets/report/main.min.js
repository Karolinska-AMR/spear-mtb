$(document).ready((function(){let drugs=["ethambutol","pyrazinamide","isoniazid","rifampicin","rifabutin","ethionamide","fluoroquinolones","ciprofloxacin","moxifloxacin","levofloxacin","ofloxacin","gatifloxacin","aminoglycosides","streptomycin","amikacin","kanamycin","gentamicin","linezolid","bedaquiline","capreomycin","delamanid","clofazimine","cycloserine","para-aminosalicylic_acid","amoxicilin-clavulanate","amoxicilin","azithromycin","clarithromycin","d-cycloserine","ertapenem","imipenem","mefloquine","meropenem","pretomanid","pas","prothionamide","sitafloxacin","cotrimoxazole","sutezolid","terizidone","thioacetazone"],catalogues=["TB-Profiler","CRyPTIC_GARC1_v1-311","WHO_GARC1_v1"],extracted_drugs={},compact_table=!0,show_mutations=!1,drug_cols=[],Sel_ID=-1;const lin_tbl=document.querySelector("#lin-tbl"),prd_tbl=document.querySelector("#prd-tbl"),omu_tbl=document.querySelector("#omu-tbl"),selected_title=document.querySelectorAll("#prd-card .selected_id");function init_page(){let lin_cols={action:"",id:"Seq. ID",lin:"Lineage",family:"Family",spoligotype:"Spoligotype",rd:"RD"},bst_cols=[];$.each(lin_cols,(function(k,v){bst_cols.push({field:k,title:v,sortable:"action"!=k})})),$(lin_tbl).bootstrapTable("destroy"),$(lin_tbl).bootstrapTable({columns:bst_cols,onResetView:function(e){rowStyle(),connect_events()}});let srch=document.querySelector(".search");$(srch).addClass("input-group-sm m-0 pb-1"),$.each(djson,(function(i,v){let d=Object.assign({},{id:v.seqid},v.lineage);d.action=`<a class="show-detail" type="button" href="#" data-sample = "${d.id}">\n                  <i class="fa fa-lg fa-circle-down"></i></a>`,$(lin_tbl).bootstrapTable("insertRow",{index:1,row:d})})),drug_cols.push({field:"cat",title:"Catalogue"}),$.each(drugs,(function(_,v){drug_cols.push({field:v,title:v.charAt(0).toUpperCase()+v.slice(1)})})),connect_events()}function connect_events(){const btns=document.querySelectorAll("#lin-tbl .show-detail");for(const btn of btns)btn.addEventListener("click",(function(e){const sample=$(this).attr("data-sample"),icons=document.querySelectorAll("#lin-tbl .show-detail svg");let tsample;for(const icon of icons)tsample=$(icon).closest("a").attr("data-sample"),tsample===sample?($(icon).removeClass("fa-circle-down").addClass("fa-circle-right"),$(icon).closest("tr").addClass("selected-row")):($(icon).removeClass("fa-circle-right").addClass("fa-circle-down"),$(icon).closest("tr").removeClass("selected-row"));Sel_ID!=sample&&(Sel_ID=sample,show_predictions(sample),show_omutations(sample),$(selected_title).text(Sel_ID)),e.preventDefault()}));const swithces=document.querySelectorAll(".form-check-input");for(const it of swithces)it.addEventListener("change",(function(event){const type=$(this).attr("data-type");"drugs"==type?compact_table=$(this).prop("checked"):"mutations"==type&&(show_mutations=$(this).prop("checked")),show_predictions(Sel_ID)}))}function show_predictions(id){if(-1==id)return;$(prd_tbl).bootstrapTable("destroy"),$(prd_tbl).bootstrapTable({columns:drug_cols});let res_vars=djson[id].res_var,cell_cnt=[],columns;extracted_drugs={},catalogues.forEach((function(cat,idx){if(!res_vars[cat])return;muts=res_vars[cat];let row={cat:cat};$.each(muts,(function(drg,mut){let phenotype;extracted_drugs[drg]=1,mutations=[],phenotype="U",mut.forEach(mu=>{"R"==mu.phenotype&&(phenotype=mu.phenotype),cl="R"==mu.phenotype?"text-danger":"text-warning",mutations.push(`<p class='${cl} fw-bold m-0 p-0'>${mu.mutation}</p>`)}),row[drg]=show_mutations?mutations.join(""):phenotype})),cell_cnt.push(row)})),document.querySelectorAll("#prd-tbl th").forEach(el=>{d=el.getAttribute("data-field"),"cat"!=d&&1!=extracted_drugs[d]&&compact_table?$(prd_tbl).bootstrapTable("hideColumn",d):$(prd_tbl).bootstrapTable("showColumn",d)}),$.each(cell_cnt,(function(i,d){$(prd_tbl).bootstrapTable("insertRow",{index:0,row:d})})),$(prd_tbl).bootstrapTable({data:cell_cnt}),paint_cells()}function show_omutations(id){$(omu_tbl).bootstrapTable("destroy"),$(omu_tbl).bootstrapTable({columns:drug_cols});let other_vars=djson[id].other_var,cell_cnt=[];if(extracted_drugs={},catalogues.forEach((function(cat,idx){if(!other_vars[cat])return;muts=other_vars[cat];let row={cat:cat};$.each(muts,(function(drg,mut){extracted_drugs[drg]=1,mutations=[],mut.forEach(mu=>{cl="S"==mu.phenotype?"text-success":"text-secondary",mutations.push(`<p class='${cl} fw-bold m-0 p-0'>${mu.mutation}</p>`)}),row[drg]=mutations.join("")})),cell_cnt.push(row)})),Object.keys(extracted_drugs).length>0){let columns;document.querySelectorAll("#omu-tbl th").forEach(el=>{d=el.getAttribute("data-field"),"cat"!=d&&1!=extracted_drugs[d]&&$(omu_tbl).bootstrapTable("hideColumn",d)}),$.each(cell_cnt,(function(i,d){$(omu_tbl).bootstrapTable("insertRow",{index:0,row:d})}))}}function paint_cells(){let cells;document.querySelectorAll("#prd-tbl td").forEach(el=>{"R"==el.innerText?$(el).addClass("table-danger text-danger fw-bold"):"U"==el.innerText&&$(el).addClass("table-warning text-warning fw-bold")})}function reset_tables(){$(prd_tbl).bootstrapTable("removeAll"),$(omu_tbl).bootstrapTable("removeAll"),Sel_ID=-1,extracted_drugs={}}function rowStyle(){let rows;lin_tbl.querySelectorAll("tbody tr").forEach(row=>{if($(row.children[1]).text()==Sel_ID)return $(row).addClass("selected-row"),void(row.children[0].innerHTML=`<a class="show-detail" type="button" href="#" data-sample = "${Sel_ID}">\n        <i class="fa fa-lg fa-circle-right"></i></a>`)})}init_page()}));